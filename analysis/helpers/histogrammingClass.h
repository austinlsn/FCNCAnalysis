#ifndef HISTCONTAINER_H
#define HISTCONTAINER_H

#include <string>
#include <map>
#include "TH1F.h"
#include "TH1D.h"
#include "TH2F.h"
#include "THn.h"
#include "../../../NanoTools/NanoCORE/SSSelections.h"

class HistContainer {
    private:
        std::map<std::string, TH1D*> hists1d_;
        std::map<std::string, TH2D*> hists2d_;
        std::map<std::string, THnF*> hists4d_;
        std::vector<std::string> region_names_;
        // std::vector<double> hct2016bins_ = {0.00839096,0.16095828,0.23802076,0.30112872,0.35890686,0.40959004,
        //                                     0.45495006,0.49485105,0.53074064,0.56373581,0.59406344,0.62193093,
        //                                     0.64864195,0.67240337,0.6958896,0.71846887,0.74127835,0.76474518,
        //                                     0.78961158,0.81917407,0.92583752};
        // std::vector<double> hct2017bins_ = {0.01013761,0.18080988,0.27036899,0.34500748,0.40774285,0.46201145,
        //                                     0.50705061,0.54527005,0.57897817,0.60883559,0.63570691,0.66000933,
        //                                     0.68395044,0.70614237,0.72753026,0.74750743,0.76703324,0.78730723,
        //                                     0.80854434,0.83436951,0.92419791};
        // std::vector<double> hct2018bins_ = {0.00937267,0.1632299,0.24426998,0.31511358,0.37514869,0.42607699,
        //                                     0.47091385,0.51076036,0.54663701,0.57872597,0.60745003,0.63452662,
        //                                     0.65994499,0.68366876,0.7062431,0.72843404,0.74939677,0.77196604,
        //                                     0.79586817,0.82420313,0.9239592};
        // std::vector<double> hut2016bins_ = {0.00914403,0.20008836,0.27453927,0.33164128,0.38055728,0.4258715,
        //                                     0.46638051,0.50288993,0.53577262,0.56536055,0.59404119,0.62042599,
        //                                     0.64466459,0.66833612,0.69075725,0.71255371,0.73426142,0.75719679,
        //                                     0.78224732,0.8122123,0.89962864};
        // std::vector<double> hut2017bins_ = {0.01574082,0.20710103,0.28442863,0.34716104,0.4023868,0.45219769,
        //                                     0.49497075,0.53230496,0.56584992,0.59485136,0.62249219,0.64754287,
        //                                     0.67023137,0.69125564,0.7117676,0.73215165,0.75223584,0.77343385,
        //                                     0.79599154,0.82391778,0.92128563};
        // std::vector<double> hut2018bins_ = {0.00764989,0.19898085,0.27207563,0.33240259,0.3853653,0.43188411,
        //                                     0.47348394,0.51067675,0.54408779,0.57346128,0.60102867,0.62634416,
        //                                     0.65081933,0.6734813,0.69579156,0.71761551,0.7386871,0.76130227,
        //                                     0.78572424,0.81636845,0.91659641};

        // standard bins
        std::vector<double> hct2016bins_ = {0.00664381,0.19700572,0.28762238,0.35702177,0.41852485,0.46981504,
                                            0.5140483,0.55344284,0.5878852,0.61896108,0.64749079,0.67274341,
                                            0.69721056,0.71897993,0.74007495,0.7596258,0.77943377,0.80007322,
                                            0.82212229,0.84957791,0.95174003};
        std::vector<double> hct2017bins_ = {0.00315058,0.19431175,0.29736627,0.37752346,0.44127761,0.49327968,
                                            0.53875172,0.57723496,0.61170031,0.64185643,0.66889886,0.6938042,
                                            0.71576739,0.73608911,0.75571284,0.77392217,0.79224801,0.81161177,
                                            0.83241789,0.85775793,0.95619053};
        std::vector<double> hct2018bins_ = {0.00479198,0.17966878,0.27458878,0.35070238,0.41352009,0.46567807,
                                            0.51136807,0.55213587,0.58714796,0.61819961,0.64662389,0.67340356,
                                            0.69772793,0.7197811,0.74084001,0.76107035,0.78023184,0.80087946,
                                            0.82352064,0.85020101,0.95095789};
        std::vector<double> hut2016bins_ = {0.00736403,0.21426591,0.29383466,0.35855735,0.41314251,0.45857105,
                                            0.49965322,0.53653497,0.56925915,0.59906112,0.62709959,0.6521008,
                                            0.67643466,0.69947938,0.72162078,0.7430641,0.76410061,0.78568389,
                                            0.80855299,0.83609562,0.93626601};
        std::vector<double> hut2017bins_ = {0.01559662,0.22217794,0.3075743,0.37751087,0.43626528,0.48550959,
                                            0.52909791,0.56672765,0.60022287,0.62953208,0.6559299,0.68061894,
                                            0.70287784,0.72394461,0.74388685,0.7637161,0.7830119,0.80281474,
                                            0.82358046,0.84841615,0.95985132};
        std::vector<double> hut2018bins_ = {0.00556834,0.20800883,0.29165759,0.3579802,0.41477358,0.46250958,
                                            0.50522264,0.542203,0.57576577,0.60614129,0.63435366,0.65923017,
                                            0.68383075,0.70642107,0.72871006,0.74944134,0.77037494,0.79134813,
                                            0.81379657,0.84081843,0.95217699};

        // // ttH bins
        // std::vector<double> hct2016bins_ = {0.01641046,0.24557028,0.32378089,0.38366765,0.43272442,0.47421724,
        //                                     0.51140332,0.54452517,0.57503587,0.60414702,0.63114422,0.65627219,
        //                                     0.67974939,0.70256785,0.72489749,0.74623161,0.766704,0.78923696,
        //                                     0.81239702,0.84136826,0.93724984};
        // std::vector<double> hct2017bins_ = {0.01345808,0.28768087,0.36911864,0.42749003,0.47354955,0.51435597,
        //                                     0.5493128,0.58013522,0.60771996,0.63383267,0.65853983,0.68141293,
        //                                     0.7036372,0.72452801,0.74423692,0.7641851,0.7830142,0.80320377,
        //                                     0.82442241,0.85178584,0.94249594};
        // std::vector<double> hct2018bins_ = {0.00925454,0.24681675,0.32500088,0.38253643,0.42957769,0.47091018,
        //                                     0.50729277,0.53872492,0.56993254,0.59812782,0.62506432,0.64958105,
        //                                     0.673154,0.69613179,0.71901052,0.74142061,0.76297977,0.7850501,
        //                                     0.80989518,0.83998709,0.94396722};
        // std::vector<double> hut2016bins_ = {0.0230941,0.25996642,0.33746175,0.39414775,0.43754381,0.47613217,
        //                                     0.50809587,0.53691337,0.56346308,0.58945861,0.6128694,0.6356938,
        //                                     0.65699956,0.67683582,0.69684207,0.71621846,0.73662946,0.75680038,
        //                                     0.7796871,0.80618299,0.89876384};
        // std::vector<double> hut2017bins_ = {0.01873036,0.31741205,0.39982067,0.45423294,0.4975523,0.53347137,
        //                                     0.56397448,0.59229661,0.61659376,0.63979583,0.66045884,0.680543,
        //                                     0.6990203,0.71678764,0.73396833,0.75128846,0.76816647,0.78556383,
        //                                     0.80464305,0.82878884,0.934771};
        // std::vector<double> hut2018bins_ = {0.020863,0.27974472,0.35495488,0.40979546,0.45242097,0.48931803,
        //                                     0.52085981,0.55030728,0.57570322,0.60074321,0.6238337,0.64608759,
        //                                     0.66642647,0.68619175,0.70588018,0.72526702,0.74579529,0.7663762,
        //                                     0.78840565,0.81548088,0.9451021};

        // // ctag bins
        // std::vector<double> hct2016bins_ = {0.01583428,0.19522768,0.26404816,0.32350127,0.37162509,0.41356763,
        //                                     0.4537675,0.48926122,0.52370242,0.5562981,0.58575074,0.61320275,
        //                                     0.64034432,0.6671786,0.69310927,0.71864705,0.74367892,0.7709849,
        //                                     0.80115489,0.83725702,0.96693838};
        // std::vector<double> hct2017bins_ = {0.01109,0.21367735,0.29391189,0.35708973,0.40835773,0.45310696,
        //                                     0.49163124,0.52800791,0.56029167,0.59062933,0.61891221,0.6461122,
        //                                     0.67181326,0.69644283,0.71969898,0.74435888,0.76811234,0.79233802,
        //                                     0.8201306,0.85479757,0.97088271};
        // std::vector<double> hct2018bins_ = {0.01629477,0.19005185,0.26448474,0.32217713,0.37238927,0.41704439,
        //                                     0.4567971,0.49258232,0.5274794,0.55799486,0.58859387,0.61793314,
        //                                     0.64549281,0.67332339,0.69908824,0.7249417,0.75003469,0.77607139,
        //                                     0.80711885,0.84419726,0.96589381};
        // std::vector<double> hut2016bins_ = {0.02842249,0.23010972,0.30338073,0.35947853,0.40442223,0.44348833,
        //                                     0.47714246,0.50710533,0.5373666,0.56492148,0.59043504,0.61586281,
        //                                     0.64075026,0.66463623,0.68826985,0.71110631,0.73455864,0.75810376,
        //                                     0.78506057,0.81593003,0.91956556};
        // std::vector<double> hut2017bins_ = {0.02348302,0.25396342,0.33070652,0.38814694,0.4362078,0.47458806,
        //                                     0.51032684,0.54189728,0.57024659,0.59719701,0.62276222,0.64652966,
        //                                     0.66900749,0.69123733,0.71254229,0.73318763,0.75452901,0.7767766,
        //                                     0.80196818,0.83167069,0.93231916};
        // std::vector<double> hut2018bins_ = {0.02658854,0.23196703,0.30426629,0.35976017,0.40545599,0.44477503,
        //                                     0.48038959,0.51351177,0.54239508,0.56932573,0.59602066,0.62064236,
        //                                     0.64417619,0.66754275,0.69094742,0.71404429,0.73700206,0.76145774,
        //                                     0.78867821,0.82074837,0.92071956};
                                            
        std::vector<std::string> getRegionNames();
        std::string getRegionName(int hyp_type, int njets, int  nbjets);
        int getSR(int hyp_type, int njets, int nbjets);
        int getCRbin(int nleps, int njets, int nbjets);
        int getEtaBin(float lep_eta, int lep_id);
        std::vector<int> getDoubleFakeBin(float lep1_pt, float lep1_eta, int lep1_id, float lep2_pt, float lep2_eta, int lep2_id);
        std::vector<int> getDoubleFlipBin(float lep1_pt, float lep1_eta, float lep2_pt, float lep2_eta);
        int counter_;
    public:
        HistContainer () : counter_(0) {region_names_=getRegionNames();}
        void addHist1d(std::string quantity, std::string sample, int nbins, float min, float max, std::string region="");
        void addHist1d(std::string quantity, std::string sample, int nbins, std::vector<double> xbins, std::string region="");
        void addHist2d(std::string quantity, std::string sample, int nbinsx, float xmin, float xmax, int nbinsy, float ymin, float ymax, std::string region="");
        void addHist2d(std::string quantity, std::string sample, int nbinsx, int nbinsy, std::vector<float> xbins, std::vector<float> ybins, std::string region="");
        void addHist4d(std::string quantity, std::string sample, int nbinsx, int nbinsy, std::vector<double> xedges, std::vector<double> yedges, std::string region="");
        void loadHists(std::string sample);
        void sumw2();
        void write();
        void fill1d(std::string quantity, std::string region, std::string sample, float value, float weight=1.);
        void fill2d(std::string quantity, std::string region, std::string sample, float xvalue, float yvalue, float weight=1.);
        void fill4d(std::string quantity, std::string region, std::string sample, float xvalue, float yvalue, float zvalue, float tvalue, float weight=1.);
        void fill(std::string sample, int best_hyp_type, Leptons &leps, Jets &jets, Jets &bjets, 
                float met, float metphi, bool isVR_SR_fake, bool isVR_CR_fake, bool isVR_SR_flip, bool isVR_CR_flip, 
                bool isEE, bool isEM, bool isME, bool isMM, bool isEFake, bool isMFake, bool isEE_flip, 
                bool isEM_flip, float hct_pred=-999, float hut_pred=-999, float weight=1., float crWeight=1.,
                bool doVariations=0, std::map<std::string, float> variationMap = {{"null", 0.}});
};

#endif